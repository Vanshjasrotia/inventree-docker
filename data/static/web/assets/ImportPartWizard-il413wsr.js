import{K as $,r as c,ab as l,an as A,ao as C,az as D,bc as I,j as e,e as O,av as R,S,N as v,ac as F,d as k,c as m,O as b,$ as H,am as N,ay as U,aw as J,C as Q,be as X,cy as Z,aa as B,T as q,aj as ee,bg as te,M as se}from"./index-DO3Hsv6V.js";import{k as ae,at as ie,a8 as re,z as G,A as le,E as ne}from"./ThemeContext-CGjWYKat.js";import{u as oe,L as M}from"./DesktopAppView-Bz_M7PvN.js";import{j as de,a6 as ce,h as K,a7 as ue}from"./Filter-BvEUIFlz.js";import{a as pe}from"./OrderPartsWizard-CSVtVPb4.js";import{S as me}from"./StockItemTable-CaVBJXX_.js";/**
 * @license @tabler/icons-react v3.34.1 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=[["path",{d:"M12 5l0 14",key:"svg-0"}],["path",{d:"M18 13l-6 6",key:"svg-1"}],["path",{d:"M6 13l6 6",key:"svg-2"}]],_e=$("outline","arrow-down","ArrowDown",xe);function fe({create:t=!1,duplicatePartInstance:r}){const s=D(),o=D(),[a,d]=c.useState(void 0),[_,u]=c.useState(void 0);return c.useMemo(()=>{const p={category:{filters:{structural:!1}},name:{},IPN:{},description:{},revision:{},revision_of:{filters:{is_revision:!1,is_template:!1}},variant_of:{filters:{is_template:!0}},keywords:{},units:{},link:{},default_location:{filters:{structural:!1}},default_supplier:{model:I.company,api_url:A(C.company_list),filters:{is_supplier:!0}},default_expiry:{},minimum_stock:{},responsible:{filters:{is_active:!0}},component:{default:o.isSet("PART_COMPONENT")},assembly:{default:o.isSet("PART_ASSEMBLY")},is_template:{default:o.isSet("PART_TEMPLATE")},testable:{default:!1},trackable:{default:o.isSet("PART_TRACKABLE")},purchaseable:{value:_,default:o.isSet("PART_PURCHASEABLE"),onValueChange:f=>{u(f)}},salable:{default:o.isSet("PART_SALABLE")},virtual:{default:o.isSet("PART_VIRTUAL"),value:a,onValueChange:f=>{d(f)}},locked:{},active:{},starred:{field_type:"boolean",label:l._({id:"7VIaU3"}),description:l._({id:"wyHaGh"}),disabled:!1,required:!1}};return t&&(p.copy_category_parameters={},a!=!1&&(p.initial_stock={icon:e.jsx(ae,{}),children:{quantity:{value:0},location:{}}}),_&&(p.initial_supplier={icon:e.jsx(ie,{}),children:{supplier:{filters:{is_supplier:!0}},sku:{},manufacturer:{filters:{is_manufacturer:!0}},mpn:{}}})),t&&r?.pk&&(p.duplicate={icon:e.jsx(re,{}),children:{part:{value:r?.pk,hidden:!0},copy_image:{value:!0},copy_bom:{value:s.isSet("PART_COPY_BOM"),hidden:!r?.assembly},copy_notes:{value:!0},copy_parameters:{value:s.isSet("PART_COPY_PARAMETERS")},copy_tests:{value:!0,hidden:!r?.testable}}}),s.isSet("PART_REVISION_ASSEMBLY_ONLY")&&(p.revision_of.filters.assembly=!0),s.isSet("PART_ENABLE_REVISION")||(delete p.revision,delete p.revision_of),s.isSet("STOCK_ENABLE_EXPIRY")||delete p.default_expiry,t&&delete p.starred,p},[a,_,t,o,r,s])}function Ae({create:t}){return c.useMemo(()=>{const s={parent:{description:l._({id:"oATGL2"}),required:!1},name:{},description:{},default_location:{filters:{structural:!1}},default_keywords:{},structural:{},starred:{field_type:"boolean",label:l._({id:"7VIaU3"}),description:l._({id:"8Qu8gC"}),disabled:!1,required:!1},icon:{field_type:"icon"}};return t&&delete s.starred,s},[t])}function Te({editTemplate:t}){const r=oe(),[s,o]=c.useState([]),[a,d]=c.useState("string");return c.useMemo(()=>({part:{disabled:!0},template:{disabled:t==!1,onValueChange:(_,u)=>{if(u?.checkbox)o([]),d("boolean");else if(u?.choices){const p=u.choices.split(",");p.length>0?(o(p.map(f=>({display_name:f.trim(),value:f.trim()}))),d("choice")):(o([]),d("string"))}else u?.selectionlist?r.get(A(C.selectionlist_detail,u.selectionlist)).then(p=>{o(p.data.choices.map(f=>({value:f.value,display_name:f.label}))),d("choice")}):(o([]),d("string"))}},data:{type:a,field_type:a,choices:a==="choice"?s:void 0,default:a==="boolean"?!1:void 0,adjustValue:_=>{let u=_.toString().trim();return a==="boolean"&&u.toLowerCase()!=="true"&&(u="false"),u}},note:{}}),[t,a,s])}function we(){return{part:{hidden:!0},quantity:{},item_count:{},cost_min:{},cost_min_currency:{},cost_max:{},cost_max_currency:{},note:{}}}const Y=({searchResult:t,partId:r,rightSection:s})=>e.jsx(H,{withBorder:!0,p:"md",shadow:"xs",children:e.jsxs(v,{justify:"space-between",align:"flex-start",gap:"xs",children:[t.image_url&&e.jsx("img",{src:t.image_url,alt:t.name,style:{maxHeight:"50px"}}),e.jsxs(S,{gap:0,flex:1,children:[e.jsx("a",{href:t.link,target:"_blank",rel:"noopener noreferrer",children:e.jsxs(k,{size:"lg",w:500,children:[t.name," (",t.sku,")"]})}),e.jsx(k,{size:"sm",children:t.description})]}),e.jsxs(v,{gap:"xs",children:[t.price&&e.jsx(k,{size:"sm",c:"primary",children:t.price}),t.exact&&e.jsx(N,{size:"sm",color:"green",children:e.jsx(m,{id:"yixoBN"})}),t.existing_part_id&&r&&t.existing_part_id===r&&e.jsx(N,{size:"sm",color:"orange",children:e.jsx(m,{id:"0MGISn"})}),t.existing_part_id&&e.jsx(M,{to:`/part/${t.existing_part_id}`,children:e.jsx(N,{size:"sm",color:"blue",children:e.jsx(m,{id:"JdmfnH"})})}),s]})]})},t.id),he=({selectSupplierPart:t,partId:r})=>{const[s,o]=c.useState(""),[a,d]=c.useState(""),[_,u]=c.useState([]),[p,f]=c.useState(!1),h=le({queryKey:["supplier-import-list"],queryFn:()=>O.get(A(C.plugin_supplier_list)).then(i=>i.data??[]),enabled:!0}),n=c.useCallback(async i=>{if(i.preventDefault(),!s||!a)return;f(!0);const[x,T]=JSON.parse(a),g=await O.get(A(C.plugin_supplier_search),{params:{plugin:x,supplier:T,term:s}});u(g.data??[]),f(!1)},[a,s]);return c.useEffect(()=>{a===""&&h.data&&h.data.length>0&&d(JSON.stringify([h.data[0].plugin_slug,h.data[0].supplier_slug]))},[h.data]),e.jsxs(S,{children:[e.jsx("form",{onSubmit:n,children:e.jsxs(v,{align:"flex-end",children:[e.jsx(U,{"aria-label":"textbox-search-for-part",flex:1,placeholder:"Search for a part",label:l._({id:"A1taO8"}),value:s,onChange:i=>o(i.currentTarget.value)}),e.jsx(J,{label:l._({id:"PYTEl0"}),value:a,onChange:i=>d(i??""),data:h.data?.map(i=>({value:JSON.stringify([i.plugin_slug,i.supplier_slug]),label:i.supplier_name}))||[],searchable:!0,disabled:h.isLoading||h.isError,placeholder:h.isLoading?l._({id:"Z3FXyt"}):h.isError?l._({id:"0Y+Is4"}):l._({id:"CrA0LQ"})}),e.jsx(b,{color:"blue",disabled:!s||!a,type:"submit",leftSection:e.jsx(ne,{}),children:e.jsx(m,{id:"A1taO8"})})]})}),p&&e.jsx(Q,{children:e.jsx(X,{})}),!p&&e.jsx(k,{size:"sm",c:"dimmed",children:e.jsx(m,{id:"hDRU5q",values:{0:_.length}})}),e.jsx(Z,{style:{maxHeight:"49vh"},children:e.jsx(S,{gap:"xs",children:_.map(i=>e.jsx(Y,{searchResult:i,partId:r,rightSection:!i.existing_part_id&&e.jsx(B,{label:l._({id:"NC6mK/"}),children:e.jsx(F,{"aria-label":`action-button-import-part-${i.id}`,onClick:()=>{const[x,T]=JSON.parse(a);t({plugin:x,supplier:T,searchResult:i})},children:e.jsx(_e,{size:18})})})},i.id))})})]})},ge=({categoryId:t,importPart:r,isImporting:s})=>{const[o,a]=c.useState(t);return e.jsxs(S,{children:[e.jsx(K,{fieldDefinition:{field_type:"related field",api_url:A(C.category_list),description:"",label:l._({id:"mkvLrG"}),model:I.partcategory,filters:{structural:!1},value:o,onValueChange:d=>a(d)}}),e.jsx(k,{children:e.jsx(m,{id:"5frVbW"})}),e.jsx(v,{justify:"flex-end",children:e.jsx(b,{"aria-label":"action-button-import-part-now",disabled:!o||s,onClick:()=>r(o),loading:s,children:e.jsx(m,{id:"N4/gep"})})})]})},je=({importResult:t,isImporting:r,skipStep:s,importParameters:o,parameterErrors:a})=>{const[d,_]=c.useState(()=>t.parameters.map(n=>({...n,use:n.parameter_template!==null}))),[u,p]=c.useMemo(()=>{const n=d.filter(x=>x.on_category&&x.use).length,i=d.filter(x=>!x.on_category&&x.use).length;return[n,i]},[d]),f=c.useMemo(()=>d.filter(n=>n.on_category).length,[d]),h=c.useCallback((n,i)=>x=>_(T=>T.map((g,y)=>n===y?{...g,[i]:x}:g)),[]);return e.jsxs(S,{children:[e.jsx(k,{size:"sm",children:e.jsx(m,{id:"VzTIlR"})}),f>0&&e.jsxs(q,{order:5,children:[e.jsx(m,{id:"DTAucM"}),e.jsx(N,{ml:"xs",children:u})]}),e.jsxs(S,{gap:"xs",children:[d.map((n,i)=>e.jsxs(S,{children:[n.on_category===!1&&d[i-1]?.on_category===!0&&e.jsxs(e.Fragment,{children:[e.jsx(ee,{}),e.jsxs(q,{order:5,children:[e.jsx(m,{id:"UjFzc9"}),e.jsx(N,{ml:"xs",children:p})]})]}),e.jsxs(v,{align:"center",gap:"xs",children:[e.jsx(te,{checked:n.use,onChange:x=>h(i,"use")(x.currentTarget.checked)}),!n.on_category&&e.jsx(B,{label:n.name,children:e.jsx(k,{w:"160px",style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:n.name})}),e.jsx(se,{flex:1,children:e.jsx(K,{hideLabels:!0,fieldDefinition:{field_type:"related field",model:I.partparametertemplate,api_url:A(C.part_parameter_template_list),disabled:n.on_category,value:n.parameter_template,onValueChange:x=>{n.parameter_template||h(i,"use")(!0),h(i,"parameter_template")(x)},error:a?.[i]?.template}})}),e.jsx(U,{flex:1,value:n.value,onChange:x=>h(i,"value")(x.currentTarget.value),error:a?.[i]?.data})]})]},i)),e.jsx(B,{label:l._({id:"7Czm8D"}),children:e.jsx(F,{onClick:()=>{_(n=>[...n,{name:"",value:"",parameter_template:null,on_category:!1,use:!0}])},children:e.jsx(ue,{size:18})})})]}),e.jsxs(v,{justify:"flex-end",children:[e.jsx(b,{onClick:s,children:e.jsx(m,{id:"6Uau97"})}),e.jsx(b,{"aria-label":"action-button-import-create-parameters",disabled:r||d.filter(n=>n.use).length===0,loading:r,onClick:()=>o(d),children:e.jsx(m,{id:"OxbLDC"})})]})]})},ye=({importResult:t,nextStep:r})=>e.jsxs(S,{children:[e.jsx(k,{size:"sm",children:e.jsx(m,{id:"KsybX7"})}),e.jsx(me,{tableName:"initial-stock-creation",allowAdd:!0,showPricing:!0,showLocation:!0,params:{part:t.part_id,supplier_part:t.supplier_part_id,pricing:t.pricing,openNewStockItem:!1}}),e.jsx(v,{justify:"flex-end",children:e.jsx(b,{onClick:r,"aria-label":"action-button-import-stock-next",children:e.jsx(m,{id:"hXzOVo"})})})]});function ze({categoryId:t,partId:r}){const[s,o]=c.useState(),[a,d]=c.useState(),[_,u]=c.useState(!1),[p,f]=c.useState(null),h=fe({create:!1}),n=de({url:C.part_list,pk:a?.part_id,title:l._({id:"enG3o5"}),fields:h}),i=c.useCallback(async({categoryId:y,partId:P})=>{u(!0);try{const w=await O.post(A(C.plugin_supplier_import),{category_id:y,part_import_id:s?.searchResult.id,plugin:s?.plugin,supplier:s?.supplier,part_id:P},{timeout:3e4});d(w.data),R({title:l._({id:"zzDlyQ"}),message:l._({id:"rzfSHc"}),color:"green"}),g.nextStep(),u(!1)}catch(w){R({title:l._({id:"SlfejT"}),message:l._({id:"Ey9Wx7"})+(w?.response?.data?.detail||w.message),color:"red"}),u(!1)}},[s]),x=c.useCallback(y=>e.jsxs(S,{gap:"xs",children:[n.modal,y>0&&s&&e.jsx(Y,{searchResult:s?.searchResult,partId:r,rightSection:a&&e.jsxs(v,{gap:"xs",children:[e.jsx(M,{to:`/part/${a.part_id}`,target:"_blank",children:e.jsx(G,{icon:"part"})}),e.jsx(F,{onClick:()=>{n.open()},children:e.jsx(G,{icon:"edit"})})]})}),y===0&&e.jsx(he,{selectSupplierPart:P=>{o(P),g.nextStep()},partId:r}),!r&&y===1&&e.jsx(ge,{isImporting:_,categoryId:t,importPart:P=>{i({categoryId:P})}}),!!r&&y===1&&e.jsxs(S,{children:[e.jsx(ce,{model:I.part,pk:r}),e.jsx(k,{children:e.jsx(m,{id:"nS8G62"})}),e.jsx(v,{justify:"flex-end",children:e.jsx(b,{disabled:_,onClick:()=>{i({partId:r})},loading:_,children:e.jsx(m,{id:"l3s5ri"})})})]}),!r&&y===2&&e.jsx(je,{importResult:a,isImporting:_,parameterErrors:p,importParameters:async P=>{u(!0),f(null);const w=P.map((j,L)=>({...j,i:L})).filter(j=>j.use),V=w.reduce((j,L,z)=>(j[L.i]=z,j),{}),W=w.map(j=>({part:a.part_id,template:j.parameter_template,data:j.value}));try{await O.post(A(C.part_parameter_list),W),R({title:l._({id:"zzDlyQ"}),message:l._({id:"Io0Vgf"}),color:"green"}),g.nextStep(),u(!1)}catch(j){if(j?.response?.status===400&&Array.isArray(j.response.data)){const L=j.response.data.map(z=>{const E={};return z.data&&(E.data=z.data.join(",")),z.template&&(E.template=z.template.join(",")),E});f(P.map((z,E)=>V[E]!==void 0&&L[V[E]]?L[V[E]]:{}))}R({title:l._({id:"SlfejT"}),message:l._({id:"RxnKd7"}),color:"red"}),u(!1)}},skipStep:()=>g.nextStep()}),y===(r?2:3)&&e.jsx(ye,{importResult:a,nextStep:()=>g.nextStep()}),y===(r?3:4)&&e.jsxs(S,{children:[e.jsx(k,{size:"sm",children:e.jsx(m,{id:"lzPS7p",values:{0:s?.supplier}})}),e.jsxs(v,{justify:"flex-end",children:[e.jsx(b,{component:M,to:`/part/${a?.part_id}`,variant:"light","aria-label":"action-button-import-open-part",children:e.jsx(m,{id:"lPyajd"})}),e.jsx(b,{component:M,to:`/purchasing/supplier-part/${a?.supplier_part_id}`,variant:"light",children:e.jsx(m,{id:"G9OJle"})}),e.jsx(b,{component:M,to:`/purchasing/manufacturer-part/${a?.manufacturer_part_id}`,variant:"light",children:e.jsx(m,{id:"MFoUdE"})}),e.jsx(b,{onClick:()=>g.closeWizard(),"aria-label":"action-button-import-close",children:e.jsx(m,{id:"yz7wBu"})})]})]})]}),[r,t,s,a,_,p,i,n.modal]),T=c.useCallback(()=>{o(void 0),d(void 0),u(!1),f(null),g.setStep(0)},[]),g=pe({title:l._({id:"rLfAc4"}),steps:[l._({id:"shWt6f"}),...r?[l._({id:"NhdTPX"})]:[l._({id:"K7tIrx"}),l._({id:"F18WP3"})],l._({id:"blbbPS"}),l._({id:"DPfwMq"})],onClose:T,renderStep:x,disableManualStepChange:!0});return g}export{ze as I,fe as a,we as b,Ae as p,Te as u};
//# sourceMappingURL=ImportPartWizard-il413wsr.js.map
