import{r,ao as _,bc as O,bV as A,j as e,ab as n,an as k,N as g,d as b,a7 as N,bP as I,a8 as Q,S,$ as P,al as y,bh as U,O as q,aq as V,ak as x,aw as Y,C as $,be as H,aj as J,ba as K,cx as v}from"./index-DO3Hsv6V.js";import{u as W}from"./UseInstance-DbCdugSa.js";import{u as L}from"./UseStatusCodes-CXNACsvT.js";import{ad as B,S as G}from"./ThemeContext-CGjWYKat.js";import{A as X}from"./ActionButton-B71_UNIq.js";import{P as Z}from"./index-B0vyf6qM.js";import{u as ee,R as se,a as te,I as re}from"./InvenTreeTable-C52lfANx.js";import{Y as le}from"./YesNoButton-COjRQttb.js";import{u as M}from"./DesktopAppView-Bz_M7PvN.js";import{j as ae,e as ie,a6 as ne,u as oe,h as de,a8 as ce}from"./Filter-BvEUIFlz.js";import{b as z}from"./IconChevronDown-XhYR5VVP.js";import{I as ue}from"./IconCircleDashedCheck-Cd0_w3eL.js";function pe(t,s,{autoInvoke:i=!1}={}){const[o,u]=r.useState(!1),m=r.useRef(null),d=r.useRef(null),f=r.useCallback(()=>{u(j=>(!j&&(!m.current||m.current===-1)&&(m.current=window.setInterval(d.current,s)),!0))},[]),p=r.useCallback(()=>{u(!1),window.clearInterval(m.current||-1),m.current=-1},[]),c=r.useCallback(()=>{o?p():f()},[o]);return r.useEffect(()=>(d.current=t,o&&f(),p),[t,o,s]),r.useEffect(()=>{i&&f()},[]),{start:f,stop:p,toggle:c,active:o}}function fe({sessionId:t}){const{instance:s,setInstance:i,refreshInstance:o,instanceQuery:u}=W({endpoint:_.import_session_list,pk:t,defaultValue:{}}),m=r.useCallback(a=>{i(a)},[]);L({modelType:O.importsession});const[d,f]=r.useState(0);r.useEffect(()=>{f(0)},[t]),r.useEffect(()=>{s.status&&s.status!==d&&f(s.status)},[s?.status]);const p=r.useMemo(()=>s?.available_fields??[],[s]),c=r.useMemo(()=>{let a=s?.columns??[];return a=a.filter(l=>!!l),a=a.filter((l,h)=>a.indexOf(l)===h),a},[s.columns]),j=r.useMemo(()=>{let a=s?.column_mappings?.map(l=>({...l,...p[l.field]??{}}))??[];return a=a.sort((l,h)=>l?.required&&!h?.required?-1:!l?.required&&h?.required?1:0),a},[s,c]),C=r.useMemo(()=>s?.column_mappings?.filter(a=>!!a.column)??[],[s]),T=r.useMemo(()=>s?.field_defaults??{},[s]),D=r.useMemo(()=>s?.field_overrides??{},[s]),R=r.useMemo(()=>s?.field_filters??{},[s]),F=r.useMemo(()=>s?.row_count??0,[s]),E=r.useMemo(()=>s?.completed_row_count??0,[s]);return{sessionData:s,setSessionData:m,sessionId:t,refreshSession:o,sessionQuery:u,status:d,availableFields:p,availableColumns:c,columnMappings:j,mappedFields:C,fieldDefaults:T,fieldOverrides:D,fieldFilters:R,rowCount:F,completedRowCount:E}}function he({session:t,column:s,row:i,onEdit:o}){const u=r.useCallback(p=>{U(p),i.complete||o?.()},[o,i]),m=r.useMemo(()=>i.errors?i?.errors[s.field]??[]:[],[i.errors,s.field]),d=r.useMemo(()=>{const p=t.availableFields[s.field];if(!i?.data)return"-";switch(p?.type){case"boolean":return e.jsx(le,{value:i.data?i.data[s.field]:!1});case"related field":if(p.model&&i.data[s.field])return e.jsx(ne,{model:p.model,pk:i.data[s.field]});break}let c=i.data?i.data[s.field]??"":"";return c||(c="-"),c},[i.data,s.field,t.availableFields]),f=r.useMemo(()=>m.length==0,[m]);return e.jsxs(I,{disabled:f,openDelay:100,closeDelay:100,children:[e.jsx(I.Target,{children:e.jsx(g,{grow:!0,justify:"apart",onClick:u,children:e.jsx(g,{grow:!0,style:{flex:1},children:e.jsx(b,{size:"xs",c:f?void 0:"red",children:d})})})}),e.jsx(I.Dropdown,{children:e.jsx(S,{gap:"xs",children:m.map(p=>e.jsx(b,{size:"xs",c:"red",children:p},p))})})]})}function me({session:t}){const s=M(),i=ee("dataimporter"),[o,u]=r.useState([]),m=r.useMemo(()=>{const a={};for(const l of o){const h=t.availableFields[l];if(h){let w=h.filters??{};if(t.fieldFilters[l]&&(w={...w,...t.fieldFilters[l]}),l=="id")continue;a[l]={...h,field_type:h.type,description:h.help_text,filters:w}}}return a},[o,t.availableFields,t.fieldFilters]),d=r.useCallback(a=>{A.show({title:n._({id:"fawxGh"}),message:n._({id:"SdvoV5"}),autoClose:!1,color:"blue",id:"importing-rows",icon:e.jsx(z,{})}),s.post(k(_.import_session_accept_rows,t.sessionId),{rows:a}).catch(()=>{A.show({title:n._({id:"SlfejT"}),message:n._({id:"aydx5i"}),color:"red",autoClose:!0})}).finally(()=>{i.clearSelectedRecords(),A.hide("importing-rows"),i.refreshTable(),t.refreshSession()})},[t.sessionId,i.refreshTable]),[f,p]=r.useState({}),c=ae({url:_.import_session_row_list,pk:f.pk,title:n._({id:"bo3Q/V"}),fields:m,initialData:f.data,fetchInitialData:!1,processFormData:a=>({data:{...f.data,...a}}),onFormSuccess:a=>i.updateRecord(a)}),j=r.useCallback((a,l)=>{l.field!="id"&&(p(a),u([l.field]),c.open())},[t,c]),C=ie({url:_.import_session_row_list,pk:f.pk,title:n._({id:"f2AJjl"}),onFormSuccess:()=>i.refreshTable()}),T=r.useCallback(a=>{if(!a.errors)return[];const l=[];for(const h of Object.keys(a.errors))a.errors[h]&&(Array.isArray(a.errors[h])?a.errors[h].forEach(w=>{l.push(`${h}: ${w}`)}):l.push(a.errors[h].toString()));return l},[]),D=r.useMemo(()=>[{accessor:"row_index",title:n._({id:"IqKCNQ"}),sortable:!0,switchable:!1,render:l=>e.jsxs(g,{justify:"left",gap:"xs",children:[e.jsx(b,{size:"sm",children:l.row_index}),l.complete&&e.jsx(N,{color:"green",size:16}),!l.complete&&l.valid&&e.jsx(ue,{color:"blue",size:16}),!l.complete&&!l.valid&&e.jsxs(I,{openDelay:50,closeDelay:100,position:"top-start",children:[e.jsx(I.Target,{children:e.jsx(Q,{color:"red",size:16})}),e.jsx(I.Dropdown,{children:e.jsxs(S,{gap:"xs",children:[e.jsxs(b,{children:[n._({id:"H14AdY"}),":"]}),T(l).map(h=>e.jsx(b,{size:"sm",c:"red",children:h},h))]})})]})]})},...t.mappedFields.map(l=>({accessor:l.field,title:l.label??l.column,sortable:!1,switchable:!0,render:h=>e.jsx(he,{session:t,column:l,row:h,onEdit:()=>j(h,l)})}))],[t]),R=r.useCallback(a=>[{title:n._({id:"g3UF2V"}),icon:e.jsx(z,{}),color:"green",hidden:a.complete||!a.valid,onClick:()=>{d([a.pk])}},se({hidden:a.complete,onClick:()=>{p(a),u(t.mappedFields.map(l=>l.field)),c.open()}}),te({onClick:()=>{p(a),C.open()}})],[t,d]),F=r.useMemo(()=>[{name:"valid",label:n._({id:"nfagfM"}),description:n._({id:"p385PV"}),type:"boolean"},{name:"complete",label:n._({id:"bD8I7O"}),description:n._({id:"ytCibL"}),type:"boolean"}],[]),E=r.useMemo(()=>{const a=i.hasSelectedRecords&&i.selectedRecords.every(l=>l.valid&&!l.complete);return[e.jsx(X,{disabled:!a,icon:e.jsx(z,{}),color:"green",tooltip:n._({id:"Fgr3ay"}),onClick:()=>{d(i.selectedRecords.map(l=>l.pk))}},"import-selected-rows")]},[i.hasSelectedRecords,i.selectedRecords]);return e.jsxs(e.Fragment,{children:[c.modal,C.modal,e.jsxs(S,{gap:"xs",children:[e.jsx(P,{shadow:"xs",p:"xs",children:e.jsxs(g,{grow:!0,justify:"apart",children:[e.jsx(b,{size:"lg",children:n._({id:"6dO0jk"})}),e.jsx(y,{}),e.jsx(Z,{maximum:t.rowCount,value:t.completedRowCount,progressLabel:!0}),e.jsx(y,{})]})}),e.jsx(re,{tableState:i,columns:D,url:k(_.import_session_row_list),props:{params:{session:t.sessionId},rowActions:R,tableActions:E,tableFilters:F,enableColumnSwitching:!0,enableColumnCaching:!1,enableSelection:!0,enableBulkDelete:!0,afterBulkDelete:()=>{t.refreshSession()}}})]})]})}function xe({column:t,options:s}){const i=M(),[o,u]=r.useState(""),[m,d]=r.useState(t.column??"");r.useEffect(()=>{d(t.column??"")},[t.column]);const f=r.useCallback(p=>{i.patch(k(_.import_session_column_mapping_list,t.pk),{column:p||""}).then(c=>{d(c.data?.column??p),u("")}).catch(c=>{const j=c.response.data;u(j.column??j.non_field_errors??n._({id:"Vw8l6h"}))})},[t]);return e.jsx(Y,{"aria-label":`import-column-map-${t.field}`,error:o,clearable:!0,searchable:!0,placeholder:n._({id:"TJu1/1"}),label:void 0,data:s,value:m,onChange:f})}function je({fieldName:t,session:s}){const i=M(),[o,u]=r.useState(""),m=r.useMemo(()=>s.availableFields[t]?.type,[t,s.availableFields]),[d]=oe(o,m=="string"?500:10),f=r.useCallback(c=>{const j={...s.fieldDefaults,[t]:c};i.patch(k(_.import_session_list,s.sessionId),{field_defaults:j}).then(C=>{s.setSessionData(C.data)}).catch(()=>{})},[t,s,s.fieldDefaults]);r.useEffect(()=>{f(d)},[d]);const p=r.useMemo(()=>{let c=s.availableFields[t];return c&&(c={...c,value:s.fieldDefaults[t],field_type:c.type,description:c.help_text,required:!1,onValueChange:j=>{u(j)}}),c},[t,s.availableFields,s.fieldDefaults]);return p&&e.jsx(de,{fieldDefinition:p,hideLabels:!0})}function be({session:t,column:s,options:i}){return e.jsxs(x.Tr,{children:[e.jsx(x.Td,{children:e.jsxs(g,{gap:"xs",children:[e.jsx(b,{fw:s.required?700:void 0,children:s.label??s.field}),s.required&&e.jsx(b,{c:"red",fw:700,children:"*"})]})}),e.jsx(x.Td,{children:e.jsx(b,{size:"sm",children:s.description})}),e.jsx(x.Td,{children:e.jsx(xe,{column:s,options:i})}),e.jsx(x.Td,{children:e.jsx(je,{fieldName:s.field,session:t})})]},s.label??s.field)}function _e({session:t}){const s=M(),[i,o]=r.useState(""),u=r.useCallback(()=>{const d=k(_.import_session_accept_fields,t.sessionId);s.post(d).then(()=>{t.refreshSession()}).catch(f=>{o(f.response?.data?.error??n._({id:"Vw8l6h"}))})},[t.sessionId]),m=r.useMemo(()=>[{value:"",label:n._({id:"ojDp4A"})},...t.availableColumns.map(d=>({value:d,label:d}))],[t.availableColumns]);return e.jsxs(S,{gap:"xs",children:[e.jsx(P,{shadow:"xs",p:"xs",children:e.jsxs(g,{grow:!0,justify:"apart",children:[e.jsx(b,{size:"lg",children:n._({id:"AHjxLx"})}),e.jsx(y,{}),e.jsx(q,{color:"green",variant:"filled",onClick:u,children:e.jsxs(g,{children:[e.jsx(B,{}),n._({id:"Y+Sfcf"})]})})]})}),i&&e.jsx(V,{color:"red",title:n._({id:"SlfejT"}),children:e.jsx(b,{children:i})}),e.jsxs(x,{children:[e.jsx(x.Thead,{children:e.jsxs(x.Tr,{children:[e.jsx(x.Th,{children:n._({id:"3mVQ03"})}),e.jsx(x.Th,{children:n._({id:"Us9epU"})}),e.jsx(x.Th,{children:n._({id:"qsUkVg"})}),e.jsx(x.Th,{children:n._({id:"aQ8swY"})})]})}),e.jsx(x.Tbody,{children:t.columnMappings.map(d=>e.jsx(be,{session:t,column:d,options:m},`import-${d.field}}`))})]})]})}function Se({session:t}){const s=r.useMemo(()=>ce(O.importsession,t.status)||n._({id:"SC1Cur"}),[t.status]);return pe(()=>{t.refreshSession()},1e3,{autoInvoke:!0}),e.jsx($,{style:{height:"100%"},children:e.jsxs(S,{gap:"xs",align:"center",justify:"center",children:[e.jsx(G,{size:"lg",children:s}),e.jsx(H,{})]})})}function ge({currentStep:t}){return e.jsxs(v,{active:t,onStepClick:void 0,allowNextStepsSelect:!1,iconSize:20,size:"xs",children:[e.jsx(v.Step,{label:n._({id:"IQ3gAw"})}),e.jsx(v.Step,{label:n._({id:"KXVPhI"})}),e.jsx(v.Step,{label:n._({id:"FhMhTR"})}),e.jsx(v.Step,{label:n._({id:"eHQfWJ"})}),e.jsx(v.Step,{label:n._({id:"b8ESNU"})})]})}function Ae({sessionId:t,opened:s,onClose:i}){const o=fe({sessionId:t}),u=L({modelType:O.importsession}),m=r.useMemo(()=>{switch(o.status){case u.INITIAL:return 0;case u.MAPPING:return 1;case u.IMPORTING:return 2;case u.PROCESSING:return 3;case u.COMPLETE:return 4;default:return 0}},[o.status]),d=r.useMemo(()=>{if(o.sessionQuery.isError)return e.jsx(V,{color:"red",title:n._({id:"SlfejT"}),icon:e.jsx(Q,{}),children:n._({id:"mfQdnw"})});switch(o.status){case u.MAPPING:return e.jsx(_e,{session:o});case u.PROCESSING:return e.jsx(me,{session:o});case u.COMPLETE:return e.jsxs(S,{gap:"xs",children:[e.jsx(V,{color:"green",title:n._({id:"4fgz8U"}),icon:e.jsx(B,{}),children:n._({id:"zdT9Dy"})}),e.jsx(q,{color:"blue",onClick:i,children:n._({id:"yz7wBu"})})]});default:return e.jsx(Se,{session:o})}},[o.status,o.sessionQuery]),f=r.useMemo(()=>e.jsxs(S,{gap:"xs",style:{width:"100%"},children:[e.jsxs(g,{gap:"xs",wrap:"nowrap",justify:"space-apart",grow:!0,preventGrowOverflow:!1,children:[e.jsx(G,{size:"lg",children:o.sessionData?.statusText??n._({id:"CTRRU5"})}),e.jsx(ge,{currentStep:m}),e.jsx(y,{})]}),e.jsx(J,{})]}),[o.sessionData]);return e.jsx(K,{position:"bottom",size:"80%",title:f,opened:s,onClose:i,withCloseButton:!0,closeOnEscape:!1,closeOnClickOutside:!1,styles:{header:{width:"100%"},title:{width:"100%"}},children:e.jsx(S,{gap:"xs",children:e.jsx(P,{p:"md",children:d})})})}function ze({modelType:t,allowUpdate:s=!1}){return{data_file:{},model_type:{value:t,hidden:t!=null},update_records:{hidden:s!==!0,value:s?void 0:!1},field_defaults:{hidden:!0,value:{}},field_overrides:{hidden:!0,value:{}},field_filters:{hidden:!0,value:{}}}}export{Ae as I,ze as d};
//# sourceMappingURL=ImporterForms-Dpl2d3ge.js.map
